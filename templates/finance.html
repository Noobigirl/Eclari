<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eclari â€” Finance Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  
  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon_io/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon_io/favicon-16x16.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/favicon_io/apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='images/favicon_io/site.webmanifest') }}">
  
  <style>
    .text-success { color: #059669 !important; }
    .text-danger { color: #dc2626 !important; }
    .table-container {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    .table-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    .finance-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    .finance-table th {
      padding: 0.75rem 1rem;
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }
    .finance-table td {
      padding: 1rem;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    .finance-table tbody tr:hover {
      background: #f9fafb;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .status-cleared {
      background: #d1fae5;
      color: #065f46;
    }
    .status-outstanding {
      background: #fee2e2;
      color: #991b1b;
    }
    .action-button {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-button:hover {
      background: #f3f4f6;
    }
    .action-button.primary {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    .action-button.primary:hover {
      background: #1d4ed8;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="{{ url_for('home') }}">
        <img class="brand-mark" src="{{ url_for('static', filename='images/favicon_io/favicon-32x32.png') }}" alt="Eclari Logo">
        <span class="brand-text">Eclari</span>
      </a>
      <nav class="nav">
        <span class="chip">Finance</span>
        <a class="button" href="{{ url_for('logout') }}">Sign out</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Finance Overview Dashboard -->
    <div class="dashboard-header" style="margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1 style="margin: 0;">Financial Dashboard - {{ user.first_name }} {{ user.last_name }}</h1>
        <div style="display: flex; gap: 1rem;">
          <button class="button button-primary" onclick="exportFinancialData()">Export Report</button>
          <button class="button" onclick="refreshData()">Refresh</button>
        </div>
      </div>
      
      <!-- Financial Summary Cards -->
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 2rem;">
        {% set total_outstanding = financial_records | sum(attribute='balance') or 0 %}
        {% set total_tuition = financial_records | sum(attribute='tuition_due') or 0 %}
        {% set total_paid = financial_records | sum(attribute='amount_paid') or 0 %}
        {% set cleared_count = financial_records | selectattr('balance', 'equalto', 0) | list | length %}
        {% set pending_count = financial_records | length - cleared_count %}
        
        <div class="card" style="padding: 1.5rem; text-align: center; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: bold; color: #9f1239;">${{ "%.2f"|format(total_outstanding) }}</div>
          <div style="color: #6b7280; font-size: 0.9rem;">Total Outstanding</div>
        </div>
        
        <div class="card" style="padding: 1.5rem; text-align: center; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: bold; color: #059669;">{{ cleared_count }}</div>
          <div style="color: #6b7280; font-size: 0.9rem;">Students Cleared</div>
        </div>
        
        <div class="card" style="padding: 1.5rem; text-align: center; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: bold; color: #d97706;">{{ pending_count }}</div>
          <div style="color: #6b7280; font-size: 0.9rem;">Pending Clearance</div>
        </div>
        
        <div class="card" style="padding: 1.5rem; text-align: center; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">{{ financial_records | length }}</div>
          <div style="color: #6b7280; font-size: 0.9rem;">Total Students</div>
        </div>
        
        <div class="card" style="padding: 1.5rem; text-align: center; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: bold; color: #059669;">${{ "%.2f"|format(total_paid) }}</div>
          <div style="color: #6b7280; font-size: 0.9rem;">Total Collected</div>
        </div>
      </div>
      
      <!-- Financial Insights Section -->
      {% if financial_records %}
      <div class="card" style="padding: 1rem; margin-bottom: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <h3 style="margin: 0; font-size: 1.1rem;">Financial Insights</h3>
          <span style="font-size: 0.9rem; color: #6b7280;">as of today</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
          {% set collection_rate = (total_paid / total_tuition * 100) if total_tuition > 0 else 100 %}
          <div>Collection Rate: <strong>{{ "%.1f"|format(collection_rate) }}%</strong></div>
          <div>Clearance Rate: <strong>{{ "%.1f"|format(cleared_count / financial_records|length * 100) }}%</strong></div>
          {% if pending_count > 0 %}
          <div>Avg. Outstanding: <strong>${{ "%.2f"|format(total_outstanding / pending_count) }}</strong></div>
          {% endif %}
          <div>Total Expected: <strong>${{ "%.2f"|format(total_tuition) }}</strong></div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Search and Filter Toolbar -->
    <div class="toolbar" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
      <input id="financeSearch" class="input" placeholder="Search students by name or ID..." style="flex: 1; min-width: 300px;">
      <select id="statusFilter" class="input" style="width: 150px;">
        <option value="">All Status</option>
        <option value="clear">Cleared</option>
        <option value="due">Has Balance</option>
      </select>
      <select id="sortBy" class="input" style="width: 150px;">
        <option value="name">Sort by Name</option>
        <option value="amount">Sort by Amount</option>
        <option value="status">Sort by Status</option>
      </select>
    </div>

    <!-- Financial Records Table -->
    <div class="table-container">
      <div class="table-header">
        Financial Records ({{ financial_records | length }} students)
      </div>
      
      <div style="overflow-x: auto;">
        <table class="finance-table" id="financeTable">
          <thead>
            <tr>
              <th onclick="sortTable('name')" style="text-align: left;">Student Name</th>
              <th onclick="sortTable('id')" style="text-align: left;">Student ID</th>
              <th onclick="sortTable('tuition')" style="text-align: right;">Tuition Due</th>
              <th onclick="sortTable('paid')" style="text-align: right;">Amount Paid</th>
              <th onclick="sortTable('balance')" style="text-align: right;">Balance</th>
              <th onclick="sortTable('status')" style="text-align: center;">Status</th>
              <th style="text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if financial_records %}
              {% for record in financial_records %}
              <tr data-student-id="{{ record.student_id.student_id }}">
                {% set student_info = record.student_id %}
                <td style="font-weight: 500; color: #111827;">
                  {{ student_info.first_name }} {{ student_info.last_name }}
                </td>
                <td style="font-family: monospace; font-size: 0.9rem; color: #6b7280;">
                  {{ student_info.student_id }}
                </td>
                <td style="text-align: right; color: #111827;">
                  ${{ "%.2f"|format(record.tuition_due or 0) }}
                </td>
                <td style="text-align: right; color: #059669;">
                  ${{ "%.2f"|format(record.amount_paid or 0) }}
                </td>
                <td style="text-align: right; font-weight: 600;" class="{% if (record.balance or 0) <= 0 %}text-success{% else %}text-danger{% endif %}">
                  ${{ "%.2f"|format(record.balance or 0) }}
                </td>
                <td style="text-align: center;">
                  {% if (record.balance or 0) <= 0 %}
                    <span class="status-badge status-cleared">Cleared</span>
                  {% else %}
                    <span class="status-badge status-outstanding">Outstanding</span>
                  {% endif %}
                </td>
                <td style="text-align: center;">
                  <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    {% if (record.balance or 0) > 0 %}
                      <button class="action-button primary" onclick="markPaid('{{ student_info.student_id }}')">
                        Mark Paid
                      </button>
                    {% endif %}
                    <button class="action-button" onclick="viewDetails('{{ student_info.student_id }}')">
                      View
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" style="text-align: center; color: #6b7280; padding: 3rem;">
                  <div style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #9ca3af;">No Financial Records</div>
                  <div style="font-size: 0.9rem;">Students with financial data will appear here when available.</div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="position: relative; margin: 5% auto; width: 80%; max-width: 600px; background: white; border-radius: 8px; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="margin: 0;">Financial Details</h2>
          <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div id="modalContent">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

  <!-- Include main app.js for common functionality -->
  <script src="{{ url_for('static', filename='js/app.bundle.js') }}"></script>
  
  <script>
    // Finance-specific JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      initializeSearchAndFilter();
      showNotification('Finance dashboard loaded successfully!', 'success');
    });

    function initializeSearchAndFilter() {
      const searchInput = document.getElementById('financeSearch');
      const statusFilter = document.getElementById('statusFilter');
      
      if (searchInput) {
        searchInput.addEventListener('input', filterTable);
      }
      
      if (statusFilter) {
        statusFilter.addEventListener('change', filterTable);
      }
    }

    function filterTable() {
      const searchTerm = document.getElementById('financeSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const rows = document.querySelectorAll('#financeTable tbody tr[data-student-id]');
      
      let visibleCount = 0;
      
      rows.forEach(row => {
        const studentName = row.children[0].textContent.toLowerCase();
        const studentId = row.children[1].textContent.toLowerCase();
        const status = row.children[5].textContent.toLowerCase();
        
        const matchesSearch = studentName.includes(searchTerm) || studentId.includes(searchTerm);
        const matchesStatus = !statusFilter || 
          (statusFilter === 'clear' && status.includes('cleared')) ||
          (statusFilter === 'due' && status.includes('outstanding'));
        
        if (matchesSearch && matchesStatus) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
      
      // Update results count
      const searchInput = document.getElementById('financeSearch');
      if (searchInput) {
        searchInput.placeholder = `Search students... (${visibleCount} shown)`;
      }
    }

    function sortTable(column) {
      const tbody = document.querySelector('#financeTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr[data-student-id]'));
      
      rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(column) {
          case 'name':
            aVal = a.children[0].textContent;
            bVal = b.children[0].textContent;
            break;
          case 'id':
            aVal = a.children[1].textContent;
            bVal = b.children[1].textContent;
            break;
          case 'tuition':
            aVal = parseFloat(a.children[2].textContent.replace('$', ''));
            bVal = parseFloat(b.children[2].textContent.replace('$', ''));
            break;
          case 'paid':
            aVal = parseFloat(a.children[3].textContent.replace('$', ''));
            bVal = parseFloat(b.children[3].textContent.replace('$', ''));
            break;
          case 'balance':
            aVal = parseFloat(a.children[4].textContent.replace('$', ''));
            bVal = parseFloat(b.children[4].textContent.replace('$', ''));
            break;
          case 'status':
            aVal = a.children[5].textContent;
            bVal = b.children[5].textContent;
            break;
          default:
            return 0;
        }
        
        if (typeof aVal === 'string') {
          return aVal.localeCompare(bVal);
        }
        return aVal - bVal;
      });
      
      rows.forEach(row => tbody.appendChild(row));
    }

    function markPaid(studentId) {
      if (confirm(`Mark student ${studentId} as paid?`)) {
        showNotification(`Payment recorded for ${studentId}`, 'success');
        // TODO: Implement backend API call
      }
    }

    function viewDetails(studentId) {
      const modal = document.getElementById('studentModal');
      const content = document.getElementById('modalContent');
      
      content.innerHTML = `
        <p><strong>Student ID:</strong> ${studentId}</p>
        <p><strong>Payment History:</strong> Coming soon</p>
        <p><strong>Notes:</strong> Financial details and history will be displayed here.</p>
      `;
      
      modal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('studentModal').style.display = 'none';
    }

    function exportFinancialData() {
      showNotification('Exporting financial data...', 'info');
      // TODO: Implement export functionality
    }

    function refreshData() {
      showNotification('Refreshing data...', 'info');
      location.reload();
    }

    function showNotification(message, type) {
      // Simple notification - you can enhance this
      console.log(`${type.toUpperCase()}: ${message}`);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('studentModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>