<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eclari â€” Finance Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  
  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon_io/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon_io/favicon-16x16.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/favicon_io/apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='images/favicon_io/site.webmanifest') }}">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="{{ url_for('home') }}">
        <img class="brand-mark" src="{{ url_for('static', filename='images/favicon_io/favicon-32x32.png') }}" alt="Eclari Logo">
        <span class="brand-text">Eclari</span>
      </a>
      <nav class="nav">
        <span class="chip">Finance</span>
        <a class="button" href="{{ url_for('logout') }}">Sign out</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1>Financial Dashboard</h1>
      <p class="muted">Managing student financial clearance for {{ user.first_name }} {{ user.last_name }}</p>
    </div>

    <!-- Financial Summary Cards -->
    <div class="stats-grid">
      {% set total_outstanding = financial_records | sum(attribute='balance') or 0 %}
      {% set total_tuition = financial_records | sum(attribute='tuition_due') or 0 %}
      {% set total_paid = financial_records | sum(attribute='amount_paid') or 0 %}
      {% set cleared_count = financial_records | selectattr('balance', 'equalto', 0) | list | length %}
      {% set pending_count = financial_records | length - cleared_count %}
      
      <div class="card stat-card">
        <div class="stat-value text-danger">${{ "%.2f"|format(total_outstanding) }}</div>
        <div class="stat-label">Total Outstanding</div>
      </div>
      
      <div class="card stat-card">
        <div class="stat-value text-success">{{ cleared_count }}</div>
        <div class="stat-label">Students Cleared</div>
      </div>
      
      <div class="card stat-card">
        <div class="stat-value text-warning">{{ pending_count }}</div>
        <div class="stat-label">Pending Clearance</div>
      </div>
      
      <div class="card stat-card">
        <div class="stat-value">{{ financial_records | length }}</div>
        <div class="stat-label">Total Students</div>
      </div>
      
      <div class="card stat-card">
        <div class="stat-value text-success">${{ "%.2f"|format(total_paid) }}</div>
        <div class="stat-label">Total Collected</div>
      </div>
    </div>

    <!-- Financial Insights -->
    {% if financial_records %}
    <div class="card">
      <div class="card-header">
        <h3>Financial Insights</h3>
        <span class="muted">as of today</span>
      </div>
      <div class="insights-grid">
        {% set collection_rate = (total_paid / total_tuition * 100) if total_tuition > 0 else 100 %}
        <div class="insight-item">
          <span class="insight-label">Collection Rate</span>
          <span class="insight-value">{{ "%.1f"|format(collection_rate) }}%</span>
        </div>
        <div class="insight-item">
          <span class="insight-label">Clearance Rate</span>
          <span class="insight-value">{{ "%.1f"|format(cleared_count / financial_records|length * 100) }}%</span>
        </div>
        {% if pending_count > 0 %}
        <div class="insight-item">
          <span class="insight-label">Avg. Outstanding</span>
          <span class="insight-value">${{ "%.2f"|format(total_outstanding / pending_count) }}</span>
        </div>
        {% endif %}
        <div class="insight-item">
          <span class="insight-label">Total Expected</span>
          <span class="insight-value">${{ "%.2f"|format(total_tuition) }}</span>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Search and Filter Toolbar -->
    <div class="toolbar">
      <input id="financeSearch" class="input" placeholder="Search students by name or ID...">
      <select id="statusFilter" class="input">
        <option value="">All Status</option>
        <option value="clear">Cleared</option>
        <option value="due">Has Balance</option>
      </select>
      <select id="sortBy" class="input">
        <option value="name">Sort by Name</option>
        <option value="amount">Sort by Amount</option>
        <option value="status">Sort by Status</option>
      </select>
      <button class="button button-primary" onclick="exportFinancialData()">Export Report</button>
    </div>

    <!-- Financial Records Table -->
    <div class="card">
      <div class="card-header">
        <h3>Financial Records</h3>
        <span class="badge">{{ financial_records | length }} students</span>
      </div>
      
      <div class="table-responsive">
        <table class="table" id="financeTable">
          <thead>
            <tr>
              <th onclick="sortTable('name')">Student Name</th>
              <th onclick="sortTable('id')">Student ID</th>
              <th onclick="sortTable('tuition')" class="text-right">Tuition Due</th>
              <th onclick="sortTable('paid')" class="text-right">Amount Paid</th>
              <th onclick="sortTable('balance')" class="text-right">Balance</th>
              <th onclick="sortTable('status')" class="text-center">Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if financial_records %}
              {% for record in financial_records %}
              <tr data-student-id="{{ record.student_id.student_id }}">
                {% set student_info = record.student_id %}
                <td class="font-medium">
                  {{ student_info.first_name }} {{ student_info.last_name }}
                </td>
                <td class="font-mono muted">
                  {{ student_info.student_id }}
                </td>
                <td class="text-right">
                  ${{ "%.2f"|format(record.tuition_due or 0) }}
                </td>
                <td class="text-right text-success">
                  ${{ "%.2f"|format(record.amount_paid or 0) }}
                </td>
                <td class="text-right font-medium {% if (record.balance or 0) <= 0 %}text-success{% else %}text-danger{% endif %}">
                  ${{ "%.2f"|format(record.balance or 0) }}
                </td>
                <td class="text-center">
                  {% if (record.balance or 0) <= 0 %}
                    <span class="badge badge-success">Cleared</span>
                  {% else %}
                    <span class="badge badge-warning">Outstanding</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="button-group">
                    {% if (record.balance or 0) > 0 %}
                      <button class="button button-sm button-primary" onclick="markPaid('{{ student_info.student_id }}')">
                        Mark Paid
                      </button>
                    {% else %}
                      <button class="button button-sm button-warning" onclick="markUnpaid('{{ student_info.student_id }}')">
                        Reverse Payment
                      </button>
                    {% endif %}
                    <button class="button button-sm" onclick="viewDetails('{{ student_info.student_id }}')">
                      View
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center empty-state">
                  <div class="empty-icon">ðŸ’°</div>
                  <h3>No Financial Records</h3>
                  <p class="muted">Students with financial data will appear here when available.</p>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Financial Details</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalContent" class="modal-body">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

  <!-- Include main app.js for common functionality -->
  <script src="{{ url_for('static', filename='js/app.bundle.js') }}"></script>
  
  <script>
    // Finance-specific JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      initializeSearchAndFilter();
    });

    function initializeSearchAndFilter() {
      const searchInput = document.getElementById('financeSearch');
      const statusFilter = document.getElementById('statusFilter');
      
      if (searchInput) {
        searchInput.addEventListener('input', filterTable);
      }
      
      if (statusFilter) {
        statusFilter.addEventListener('change', filterTable);
      }
    }

    function filterTable() {
      const searchTerm = document.getElementById('financeSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const rows = document.querySelectorAll('#financeTable tbody tr[data-student-id]');
      
      let visibleCount = 0;
      
      rows.forEach(row => {
        const studentName = row.children[0].textContent.toLowerCase();
        const studentId = row.children[1].textContent.toLowerCase();
        const status = row.children[5].textContent.toLowerCase();
        
        const matchesSearch = studentName.includes(searchTerm) || studentId.includes(searchTerm);
        const matchesStatus = !statusFilter || 
          (statusFilter === 'clear' && status.includes('cleared')) ||
          (statusFilter === 'due' && status.includes('outstanding'));
        
        if (matchesSearch && matchesStatus) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
    }

    function sortTable(column) {
      const tbody = document.querySelector('#financeTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr[data-student-id]'));
      
      rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(column) {
          case 'name':
            aVal = a.children[0].textContent;
            bVal = b.children[0].textContent;
            break;
          case 'id':
            aVal = a.children[1].textContent;
            bVal = b.children[1].textContent;
            break;
          case 'tuition':
            aVal = parseFloat(a.children[2].textContent.replace('$', ''));
            bVal = parseFloat(b.children[2].textContent.replace('$', ''));
            break;
          case 'paid':
            aVal = parseFloat(a.children[3].textContent.replace('$', ''));
            bVal = parseFloat(b.children[3].textContent.replace('$', ''));
            break;
          case 'balance':
            aVal = parseFloat(a.children[4].textContent.replace('$', ''));
            bVal = parseFloat(b.children[4].textContent.replace('$', ''));
            break;
          case 'status':
            aVal = a.children[5].textContent;
            bVal = b.children[5].textContent;
            break;
          default:
            return 0;
        }
        
        if (typeof aVal === 'string') {
          return aVal.localeCompare(bVal);
        }
        return aVal - bVal;
      });
      
      rows.forEach(row => tbody.appendChild(row));
    }

    function markPaid(studentId) {
      if (confirm(`Mark student ${studentId} as paid?`)) {
        if (window.showNotification) {
          window.showNotification(`Payment recorded for ${studentId}`, 'success');
        }
        // TODO: Implement backend API call
      }
    }

    function markUnpaid(studentId) {
      if (confirm(`Reverse payment for student ${studentId}? This will mark them as having an outstanding balance.`)) {
        if (window.showNotification) {
          window.showNotification(`Payment reversed for ${studentId}`, 'warning');
        }
        // TODO: Implement backend API call
      }
    }

    function viewDetails(studentId) {
      const modal = document.getElementById('studentModal');
      const content = document.getElementById('modalContent');
      
      content.innerHTML = `
        <p><strong>Student ID:</strong> ${studentId}</p>
        <p><strong>Payment History:</strong> Coming soon</p>
        <p class="muted">Financial details and history will be displayed here.</p>
      `;
      
      modal.style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('studentModal').style.display = 'none';
    }

    function exportFinancialData() {
      if (window.showNotification) {
        window.showNotification('Exporting financial data...', 'info');
      }
      // TODO: Implement export functionality
    }

    function refreshData() {
      location.reload();
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('studentModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>