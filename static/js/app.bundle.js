import{s as B,g as O,a as K,b as N,c as D,o as H}from"./auth.bundle.js";(function(){const n=e=>document.querySelector(e),b=n("#role"),f=n("#roleTrigger"),v=n("#roleTriggerText"),w=n("#roleMenu"),m=n("#roleSelectWrap"),C=n("#loginSubtitle"),g=document.querySelector(".auth-visual"),E={student:{subtitle:"African Leadership Academy • Student Clearance Portal",bg:"url('/static/images/students.jpeg')"},teacher:{subtitle:"African Leadership Academy • Teacher Clearance Dashboard",bg:"url('/static/images/teacher.jpeg')"},finance:{subtitle:"African Leadership Academy • Finance Clearance Dashboard",bg:"url('/static/images/finance.jpeg')"},hall:{subtitle:"African Leadership Academy • Hall Clearance Dashboard",bg:"url('/static/images/hall.jpeg')"},coach:{subtitle:"African Leadership Academy • Sports Clearance Dashboard",bg:"url('/static/images/coach.jpeg')"},lab:{subtitle:"African Leadership Academy • Labs Clearance Dashboard",bg:"url('/static/images/lab.jpeg')"}};let y=null;function R(e,a){const t=new Image;t.onload=a,t.src=e.replace(/^url\(['"]?|['"]?\)$/g,"").replace(/^url\('/,"").replace(/'\)$/,"")}function x(e){const a=E[e]||E.student;g&&(y&&(clearTimeout(y),y=null),C&&(C.style.opacity="0",setTimeout(()=>{C.textContent=a.subtitle,C.style.opacity="1"},120)),R(a.bg.replace(/^url\(|\)$/g,"").replace(/['"]/g,""),()=>{g.style.setProperty("--auth-visual-bg-next",a.bg),g.classList.add("fade-in"),y=setTimeout(()=>{g.style.setProperty("--auth-visual-bg",a.bg),g.style.setProperty("--auth-visual-bg-next","none"),g.classList.remove("fade-in"),y=null},360)}))}if(b&&(x(b.value),b.addEventListener("change",e=>x(e.target.value))),f&&w&&b&&m){let e=function(){m.classList.remove("select-open"),f.setAttribute("aria-expanded","false")},a=function(){m.classList.add("select-open"),f.setAttribute("aria-expanded","true")};const t=Array.from(w.querySelectorAll(".select-option"));f.addEventListener("click",()=>{m.classList.contains("select-open")?e():a()}),t.forEach(l=>{l.addEventListener("click",()=>{const o=l.getAttribute("data-value");b.value=o,v.textContent=l.textContent,t.forEach(c=>c.setAttribute("aria-selected",String(c===l))),b.dispatchEvent(new Event("change")),e()}),l.addEventListener("keydown",o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),l.click()),o.key==="Escape"&&(e(),f.focus());const c=t.indexOf(l);o.key==="ArrowDown"&&(o.preventDefault(),(t[c+1]||t[0]).focus()),o.key==="ArrowUp"&&(o.preventDefault(),(t[c-1]||t[t.length-1]).focus())})}),document.addEventListener("click",l=>{m.contains(l.target)||e()});const s=t.find(l=>l.getAttribute("data-value")===b.value)||t[0];s&&(v.textContent=s.textContent,t.forEach(l=>l.setAttribute("aria-selected",String(l===s))))}const L=n("#year");L&&(L.textContent=new Date().getFullYear());const d=n("#loginBtn");if(d){let e=n("#loginError");e||(e=document.createElement("div"),e.id="loginError",e.style.color="#ef4444",e.style.marginTop="8px",e.style.display="none",d.parentNode.insertBefore(e,d)),d.addEventListener("click",async()=>{e.style.display="none",e.textContent="";const a=d.textContent;d.textContent="Signing in...",d.disabled=!0;try{const t=n("#id").value.trim(),s=n("#password").value.trim(),l=n("#role").value;if(!t||!s)throw new Error("Please enter both email and password");const{user:o,session:c,error:p}=await B(t,s);if(p)throw new Error(p);if(o&&c){const u=O(o);console.log(`Login successful for ${o.email} with role: ${u}`);const r={student:"/dashboard/student",teacher:"/dashboard/teacher",finance:"/dashboard/finance",hall:"/dashboard/hall",coach:"/dashboard/coach",lab:"/dashboard/lab"};window.location.href=r[u]||r[l]||"/dashboard/student"}else throw new Error("Login failed - no session created")}catch(t){console.error("Login error:",t),e.textContent=t.message||"Login failed. Please try again.",e.style.display="block"}finally{d.textContent=a,d.disabled=!1}}),["#id","#password"].forEach(a=>{const t=n(a);t&&t.addEventListener("keypress",s=>{s.key==="Enter"&&(s.preventDefault(),d.click())})})}window.addEventListener("DOMContentLoaded",async()=>{if(window.location.pathname==="/login"){const{user:e,session:a}=await K();if(e&&a){console.log("Existing session found, redirecting...");const t=O(e),s={student:"/dashboard/student",teacher:"/dashboard/teacher",finance:"/dashboard/finance",hall:"/dashboard/hall",coach:"/dashboard/coach",lab:"/dashboard/lab"};window.location.href=s[t]||"/dashboard/student"}}});const $=n("#logoutBtn");$&&$.addEventListener("click",async e=>{e.preventDefault();try{await N(),D(),window.location.href="/login"}catch(a){console.error("Logout error:",a),D(),window.location.href="/login"}}),H((e,a)=>{e==="SIGNED_OUT"&&window.location.pathname!=="/login"&&(window.location.href="/login")});const S=n("#portals");if(S){const e=[{id:"wr",label:"W&R"},{id:"afst",label:"Af. St"},{id:"math",label:"Math"},{id:"cs",label:"CS"},{id:"econ",label:"Econ"}];e.forEach(r=>{const i=document.createElement("a");i.href=`/subject?subject=${encodeURIComponent(r.label)}`,i.className="portal";const h=document.createElement("span");h.textContent=r.label,i.appendChild(h),S.appendChild(i)});const a=[{text:"Clear Math S1 Book",done:!1},{text:"Physics Book",done:!1},{text:"Clear Dues w/ Finance",done:!1}],t=n("#todoList");t&&a.forEach(r=>{const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.gap="8px",i.innerHTML=`<span>${r.text}</span><span class="badge ${r.done?"badge-success":"badge-warning"}">${r.done?"Done":"Pending"}</span>`,t.appendChild(i)});const s=Math.round(a.filter(r=>r.done).length/a.length*100),l=n("#overallFill"),o=n("#overallPct");l&&o&&(l.style.width=s+"%",o.textContent=s+"%");const c=n("#overallStatus");if(c){const r=s===100;c.textContent=r?"Overall: Approved":"Overall: Pending",c.className="badge "+(r?"badge-success":"badge-warning")}const p=n("#exportBtn");p&&p.addEventListener("click",()=>alert("This will export PDF/CSV/Excel once backend is connected."));const u=n("#subjectSelect");u&&e.forEach(r=>{const i=document.createElement("option");i.value=r.id,i.textContent=r.label,u.appendChild(i)}),n("#uploadBtn")?.addEventListener("click",()=>{const r=n("#itemCode").value.trim(),i=n("#photo").files[0],h=n("#uploadResult");if(!r||!i){h.textContent="Please provide item code and a photo.";return}if(!i.type.startsWith("image/")){h.textContent="Please upload a valid image.";return}h.textContent="Uploaded successfully. Awaiting teacher validation."})}const T=n("#subjectTitle");if(T){const a=new URLSearchParams(location.search).get("subject")||"Subject";T.textContent=a;const t=[{text:`${a} S1 Book`,done:!1},{text:"Return Calculator",done:!0},{text:`${a} P1 Book`,done:!1}],s=Math.round(t.filter(o=>o.done).length/t.length*100);n("#subjectPct").textContent=s+"%",n("#subjectFill").style.width=s+"%";const l=n("#subjectTodo");t.forEach(o=>{const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.alignItems="center",c.style.gap="8px",c.innerHTML=`<span>${o.text}</span><span class="badge ${o.done?"badge-success":"badge-warning"}">${o.done?"Completed":"Press to Clear Now"}</span>`,l.appendChild(c)})}const k=n("#teacherTable tbody");if(k){[{class:"Math Y2-A",student:"S12345 • Ama N.",subject:"Mathematics",item:"Textbook MATH-BOOK-12",returned:!1},{class:"Math Y2-A",student:"S12002 • Malik O.",subject:"Mathematics",item:"Workbook MATH-WB-07",returned:!0},{class:"Physics Y1-B",student:"S12811 • Tumi K.",subject:"Physics",item:"Calculator CALC-84",returned:!1}].forEach(t=>{const s=document.createElement("tr");s.innerHTML=`
        <td>${t.class}</td>
        <td>${t.student}</td>
        <td>${t.subject}</td>
        <td>${t.item}</td>
        <td><span class="badge ${t.returned?"badge-success":"badge-warning"}">${t.returned?"Returned":"Not Returned"}</span></td>
        <td>
          <button class="button button-primary">Mark Returned</button>
          <button class="button">Flag Issue</button>
        </td>
      `,k.appendChild(s)});const a=n("#sigPad");if(a){const t=a.getContext("2d");let s=!1,l=null;a.addEventListener("pointerdown",o=>{s=!0,l=[o.offsetX,o.offsetY]}),a.addEventListener("pointerup",()=>{s=!1,l=null}),a.addEventListener("pointermove",o=>{if(!s)return;const[c,p]=l,u=o.offsetX,r=o.offsetY;t.strokeStyle="#e5e7eb",t.lineWidth=2,t.lineCap="round",t.beginPath(),t.moveTo(c,p),t.lineTo(u,r),t.stroke(),l=[u,r]}),n("#clearSig")?.addEventListener("click",()=>{t.clearRect(0,0,a.width,a.height)}),n("#saveSig")?.addEventListener("click",()=>{alert("Signature saved (mock).")})}}const A=n("#financeTable tbody");if(A){const e=[{name:"S12345 • Ama N.",tuition:0,replace:0,status:"Clear"},{name:"S12002 • Malik O.",tuition:300,replace:0,status:"Due"},{name:"S12811 • Tumi K.",tuition:0,replace:45,status:"Due"}],a=t=>t==="Clear"?"badge-success":"badge-danger";e.forEach(t=>{const s=document.createElement("tr");s.innerHTML=`
        <td>${t.name}</td>
        <td>$${t.tuition}</td>
        <td>$${t.replace}</td>
        <td><span class="badge ${a(t.status)}">${t.status}</span></td>
      `,A.appendChild(s)})}const M=n("#hallTable tbody");if(M){const e=[{student:"S12345 • Ama N.",hall:"Kibo",room:"A-203",status:"OK"},{student:"S12002 • Malik O.",hall:"Kibo",room:"A-118",status:"Not OK"}],a=t=>t==="OK"?"badge-success":"badge-danger";e.forEach(t=>{const s=document.createElement("tr");s.innerHTML=`
        <td>${t.student}</td>
        <td>${t.hall}</td>
        <td>${t.room}</td>
        <td><span class="badge ${a(t.status)}">${t.status}</span></td>
        <td>
          <button class="button button-primary">Mark OK</button>
          <button class="button">Mark Not OK</button>
        </td>
      `,M.appendChild(s)})}const j=n("#coachTable tbody");if(j){const e=[{student:"S12345 • Ama N.",sport:"Basketball",item:"Jersey #12",status:"Returned"},{student:"S12811 • Tumi K.",sport:"Soccer",item:"Shin Guards",status:"Lost"}],a=t=>t==="Returned"?"badge-success":"badge-danger";e.forEach(t=>{const s=document.createElement("tr");s.innerHTML=`
        <td>${t.student}</td>
        <td>${t.sport}</td>
        <td>${t.item}</td>
        <td><span class="badge ${a(t.status)}">${t.status}</span></td>
        <td>
          <button class="button button-primary">Mark Returned</button>
          <button class="button">Flag Lost</button>
        </td>
      `,j.appendChild(s)})}const P=n("#labTable tbody");if(P){const e=[{student:"S12345 • Ama N.",subject:"Chemistry",item:"Goggles",cost:0,status:"OK"},{student:"S12002 • Malik O.",subject:"Biology",item:"Lab Manual",cost:15,status:"Cost"}],a=t=>t==="OK"?"badge-success":"badge-warning";e.forEach(t=>{const s=document.createElement("tr");s.innerHTML=`
        <td>${t.student}</td>
        <td>${t.subject}</td>
        <td>${t.item}</td>
        <td>$${t.cost}</td>
        <td><span class="badge ${a(t.status)}">${t.status}</span></td>
        <td>
          <button class="button button-primary">Resolve</button>
        </td>
      `,P.appendChild(s)})}})();
